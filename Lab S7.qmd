---
title: "Lab S7"
author: "Hewan Weldai"
format:
  html:
    toc: true
    toc_float: true
    embed-resources: true
execute: 
  warning: false
  message: false
---

**Exercise**

```{r}
# Load libraries
library(tidyverse)

# Read in your dataset
df <- read_csv("NEON_soilMAGs_soilChem.csv")

# Inspect column names
glimpse(df)
```

**Interactive Map Showing the relative abundance within each site**

```{r}

# Install if needed
# install.packages("leaflet")
# install.packages("dplyr")

library(leaflet)
library(dplyr)

# --- Step 1: Read in your dataset ---
df <- read.csv("NEON_soilMAGs_soilChem.csv", header = TRUE, stringsAsFactors = FALSE)

# --- Step 2: Summarize relative abundance per site × phylum ---
# If you don’t have an explicit abundance column, we’ll use counts of MAGs per phylum
site_summary <- df %>%
  group_by(site, decimalLatitude, decimalLongitude, phylum) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(site) %>%
  mutate(RelAbund = count / sum(count)) %>%
  ungroup()

# --- Step 3: Define color palette for phyla ---
pal <- colorFactor(palette = "Set1", domain = site_summary$phylum)

# --- Step 4: Build interactive map ---
leaflet(site_summary) %>%
  addProviderTiles("CartoDB.Positron") %>%   # nice basemap
  addCircleMarkers(
    lng = ~decimalLongitude,
    lat = ~decimalLatitude,
    radius = ~RelAbund * 50,   # scale circle size by relative abundance
    color = ~pal(phylum),
    stroke = FALSE,
    fillOpacity = 0.7,
    popup = ~paste0(
      "<b>Site:</b> ", site, "<br>",
      "<b>Phylum:</b> ", phylum, "<br>",
      "<b>Relative Abundance:</b> ", round(RelAbund, 3)
    )
  ) %>%
  addLegend(
    "bottomright",
    pal = pal,
    values = ~phylum,
    title = "Phylum",
    opacity = 1
  )
```
