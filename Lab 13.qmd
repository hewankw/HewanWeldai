---
title: "Lab 13"
author: "Hewan Weldai"
format:
  html:
    toc: true
    toc_float: true
    embed-resources: true
execute: 
  warning: false
  message: false
bibliography: hewan.bib
---

# From Previous Labs

In effort to analyze data from a table of Metagenome Assembled genomes (MAGS) from sites a part of the National Ecological Observatory Network, I used UMass Copilot AI to help create an R script.

In my previous efforts, I was able to create a first create the combined csv file with all of the correct data, load this file into R, and download the correct packages for these different analyses.

```{r}
# Load libraries
library(tidyverse)
library(lubridate)
library(DT)
library(viridis)
library(janitor)
library(plotly)
library(respirometry)
library(tidyverse)
```

```{r}
# Read in your dataset
df <- read_csv("NEON_soilMAGs_soilChem.csv")

# Inspect column names
glimpse(df)
```

I started by asking co-pilot for help with making a stacked bar graph looking at the relative abundance of each phylum of bacteria.

In this code, we take taxonomic data count the abundance of each phylum at the different sites, calculate the relative abundance of phylum's at each site, and visualize it through a stacked bar graph.

```{r}
#| fig-height: 10
#| fig-width: 20
#MAKING A RELATIVE ABUNDANCE GRAPH
library(dplyr)
library(tidyr)
library(ggplot2)

# --- Parse taxonomy ---
taxonomy_split <- df %>%
  separate(gtdb_taxonomy_lineage,
           into = c("Domain","Phylum","Class","Order","Family","Genus"),
           sep = ";", fill = "right", remove = FALSE)

# --- Summarize composition at Phylum level per Site ---
phylum_counts <- taxonomy_split %>%
  group_by(site, Phylum) %>%
  summarise(total_abundance = n(), .groups = "drop") %>%
  group_by(site) %>%
  mutate(RelativeAbundance = total_abundance / sum(total_abundance)) %>%
  ungroup()

# --- Plot stacked bar chart ---
ggplot(phylum_counts, aes(x = site, y = RelativeAbundance, fill = Phylum)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Relative Abundance of Phyla Across Sites",
       x = "Site",
       y = "Relative Abundance") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## Making a Heat Map of Relative Abundance

In effort to visualize our newly transformed data set in a new way, I asked Co-Pilot to create an R-script for a heat map showing the relative abundance of each phylum. Here we are taking the same transformed data set from before, but just changing the visualization.

```{r}
#| fig-height: 10
#| fig-width: 15
library(ggplot2)

ggplot(phylum_counts, aes(x = site, y = Phylum, fill = RelativeAbundance)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  theme_minimal() +
  labs(title = "Heatmap of Phylum Relative Abundance",
       x = "Site",
       y = "Phylum",
       fill = "Rel. Abundance")

```

# New Ideas:

After creating these two figures, I wanted to explore the different analyses that are possible with a large data set like this.

I re-uploaded the csv file to copilot and asked: What types of analyses in R should I run with this data set?

In summary, Co-pilot responded with :

**Microbial Community Analyses**

-   Taxonomic composition

    -   Summarize counts or relative abundances at different taxonomic levels (phylum, genus).

    -   Visualize with stacked bar plots, pie charts, or heatmaps.

-   Diversity metrics

    -   Calculate alpha diversity (Shannon, Simpson) per site.

    -   Compare beta diversity (Bray–Curtis, Jaccard) between sites.

    -   Packages: vegan, phyloseq.

**Environmental & Geographic Associations**

-   **Ordination methods**

    -   PCA, NMDS, or PCoA to see clustering of sites by taxonomy or soil chemistry.

    -   Canonical correspondence analysis (CCA) or redundancy analysis (RDA) to link microbial composition with soil variables.

<!-- -->

-   **Regression models**

    -   Linear or generalized linear models to test how soil chemistry (pH, nutrients, C:N ratio) predicts microbial diversity or abundance.

-   **Spatial visualization**

    -   Map MAG distributions across sites using **ggplot2** + **sf**.

**Functional & Ecological Insights**

-   **Indicator taxa analysis**

    -   Identify taxa strongly associated with particular soil conditions.

-   **Co-occurrence networks**

    -   Build correlation networks of MAGs to explore microbial interactions.

    -   Package: **igraph**.

-   **Trait-based analysis**

    -   If functional annotations are available, compare metabolic potential across environments.

**Data Exploration & Visualization**

-   **Heatmaps**

    -   Show abundance of taxa across sites with soil chemistry gradients.

-   **Boxplots/violin plots**

    -   Compare diversity or abundance across categorical variables (soil type, biome).

-   **Correlation matrices**

    -   Explore relationships among soil chemistry variables and microbial metrics.

All of this was really useful information and allowed to build a framework for the different analyses I wanted to complete using this MAG data set.

I next had Co-pilot conduct a step by step work flow to do the previously mentioned analyses starting from the beginning with loading in the csv file.

## Setup and Data Loading

Here I just want to load all of the packages into R and check that the column names and types are all correct.

```{r}
# Core packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(forcats)

# Ecology and ordination
library(vegan)

# Read data
df <- read.csv("NEON_soilMAGs_soilChem.csv", header = TRUE, stringsAsFactors = FALSE)


# Quick checks
names(df)
str(df)

```

## Cleaning and Taxonomy Parsing

Here I am separating the taxonomy into levels and cleaning up the data.

```{r}
# Trim whitespace in taxonomy strings (helps avoid duplicate labels)
df <- df %>%
  mutate(gtdb_taxonomy_lineage = trimws(gtdb_taxonomy_lineage))

# Parse taxonomy into levels
taxonomy_split <- df %>%
  separate(
    gtdb_taxonomy_lineage,
    into = c("Domain","Phylum","Class","Order","Family","Genus"),
    sep = ";",
    fill = "right",
    remove = FALSE
  ) %>%
  mutate(
    Domain = trimws(Domain),
    Phylum = trimws(Phylum),
    Class  = trimws(Class),
    Order  = trimws(Order),
    Family = trimws(Family),
    Genus  = trimws(Genus)
  )

# Optional: clean prefixes like "d__", "p__", etc.
strip_prefix <- function(x) sub("^[a-z]__", "", x)
taxonomy_split <- taxonomy_split %>%
  mutate(
    Domain = strip_prefix(Domain),
    Phylum = strip_prefix(Phylum),
    Class  = strip_prefix(Class),
    Order  = strip_prefix(Order),
    Family = strip_prefix(Family),
    Genus  = strip_prefix(Genus)
  )

```

## Build site-by-taxon matrix

Similar to the previous labs workflow, Co-pilot had me start by calculating the relative abundance in a site-by-taxon matrix. Here I am calculating the relative abundance aka the number of MAGs per phylum per site.

### Counts if no abundance column present

```{r}
# Site × Phylum counts (number of MAGs per phylum per site)

phylum_abundance <- taxonomy_split %>%
  group_by(site, Phylum) %>%
  summarise(count = n(), .groups = "drop") %>%
  pivot_wider(names_from = Phylum, values_from = count, values_fill = 0)

# Ensure Site is kept as an ID
phylum_abundance <- phylum_abundance %>% arrange(site)

```

#### Relative abundance per site

```{r}
# Convert to long and compute within-site relative abundance
phylum_long <- phylum_abundance %>%
  pivot_longer(-site, names_to = "Phylum", values_to = "Count") %>%
  group_by(site) %>%
  mutate(RelAbund = Count / sum(Count)) %>%
  ungroup()

```

#### Stacked bars of relative abundance

Here I am building another stacked bar graph using the calculated relative abundance with the cleaned up data set. For the second part of this process, I am visualizing this data with ggplot.

```{r}
#| fig-height: 10
#| fig-width: 20
# Order phyla by overall mean abundance for consistent coloring
phylum_order <- phylum_long %>%
  group_by(Phylum) %>%
  summarise(mean_rel = mean(RelAbund)) %>%
  arrange(desc(mean_rel)) %>%
  pull(Phylum)

phylum_long$Phylum <- factor(phylum_long$Phylum, levels = phylum_order)

ggplot(phylum_long, aes(x = site, y = RelAbund, fill = Phylum)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Relative abundance of phyla across sites", y = "Relative abundance", x = "Site") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## Diversity metrics (alpha and beta)

In effort to better understand the diversity at each site, we can calculate the alpha diversity (Shannon/Simpson) as well as the beta diversity (Bray-Curtis). From Co-pilot, I learned that the alpha diversity measures the diversity or richness within a single sample. The Shannon index is important for understand how abundance is distributes across all the species at a site. The Simpson index is useful for highlight the dominance of a few species at a site.

```{r}
# Alpha diversity (Shannon, Simpson) using counts
comm_matrix <- phylum_abundance %>% select(-site) %>% as.matrix()

alpha_df <- data.frame(
  site = phylum_abundance$site,
  Shannon = diversity(comm_matrix, index = "shannon"),
  Simpson = diversity(comm_matrix, index = "simpson")
)

# Beta diversity (Bray-Curtis)
bray <- vegdist(comm_matrix, method = "bray")

```

**Co-Pilot's Notes on Interpretation:** Higher Shannon/Simpson indicate more diverse phylum composition per site.

#### Alpha diversity box plots by a categorical variable

This next code chunk takes the previous information we collected about the alpha diversity aka the Shannon/Simpson values and visualizes the data in a box plot so we can see the distribution.

```{r}
#| fig-height: 5
#| fig-width: 25
# Example: biome or soil type (adjust column name)
alpha_plot_df <- alpha_df %>%
  left_join(df %>% select(site, phylum) %>% distinct(), by = "site")

ggplot(alpha_plot_df, aes(x = phylum, y = Shannon)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Shannon diversity by soil type", x = "Soil type", y = "Shannon")

ggplot(alpha_plot_df, aes(x = phylum, y = Simpson)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Simpson diversity by soil type", x = "Soil type", y = "Simpson")
```

#### NMDS (robust for community data) Visualizing the Beta Diversity.

To understand the Beta diversity information, we can transform this data and visualize it different ways. The first code chunk was my first iteration of the NMDS plot which is basically just a plot that reduces complex data ina 2D map.

```{r}
set.seed(42)
nmds <- metaMDS(comm_matrix, distance = "bray", k = 2, trymax = 100)
nmds_scores <- as.data.frame(nmds$points)
nmds_scores$site <- phylum_abundance$site

ggplot(nmds_scores, aes(x = MDS1, y = MDS2)) +
  geom_point(size = 3, alpha = 0.8, color = "tomato") +
  theme_minimal() +
  labs(title = "NMDS (Bray-Curtis) of sites by phylum composition")

```

In this second code chunk, I asked co-pilot to help me visualize this data in a different way using a heat map to show the difference between each of the sites.

Here are some notes from Co-Pilot:

### What this does

-   **NMDS plot**: Shows sites positioned in 2D space based on Bray–Curtis dissimilarities. Sites closer together have more similar phylum compositions.

-   **Heatmap**: Shows pairwise dissimilarities between all sites. Darker colors = more dissimilar.

```{r}
#| fig-height: 12
#| fig-width: 15

#Load Libraries
library(vegan)
library(ggplot2)
library(reshape2)

# --- Alpha diversity (already computed) ---
comm_matrix <- phylum_abundance %>% select(-site) %>% as.matrix()


alpha_df <- data.frame(
  site = phylum_abundance$site,
  Shannon = diversity(comm_matrix, index = "shannon"),
  Simpson = diversity(comm_matrix, index = "simpson")
)

# --- Beta diversity (Bray-Curtis) ---
bray <- vegdist(comm_matrix, method = "bray")

# --- Option 2: Heatmap of Bray-Curtis distances ---
bray_matrix <- as.matrix(bray)
rownames(bray_matrix) <- phylum_abundance$site
colnames(bray_matrix) <- phylum_abundance$site

# Melt for ggplot
bray_melt <- melt(bray_matrix)

ggplot(bray_melt, aes(x = Var1, y = Var2, fill = value)) +
  geom_tile() +
  scale_fill_viridis_c(option = "plasma") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Bray-Curtis Dissimilarity Heatmap",
       x = "Site", y = "Site", fill = "Dissimilarity")

```

## Ordination (PCA)

To see if there is any clustering of sites by taxonomy or other variables, we can use a PCA plot to do so.

In order to make a PCA we need to prepare the data. I asked Co-Pilot to help me prep the MAG data for the PCA plot.

**Ensure numeric matrix:** Convert all taxa columns to numeric, replace NA with 0 before ordination.

```{r}
comm_matrix <- phylum_abundance %>% select(-site) %>% mutate(across(everything(), as.numeric)) %>% as.matrix()
comm_matrix[is.na(comm_matrix)] <- 0

```

I first start this PC analysis by doing a Hellinger transofrmation on this data set. This transformation refers to data that has been adjusted by taking the square root of each species relative abundance within a sample to make it suitable for linear ordination aka PCA.

#### PCA on Hellinger-transformed data

```{r}
# Hellinger transformation (recommended for community composition)
comm_hell <- decostand(comm_matrix, method = "hellinger")

# PCA
pca_res <- rda(comm_hell)  # PCA via RDA on Hellinger data
pca_scores <- scores(pca_res, display = "sites") %>% as.data.frame()
pca_scores$site <- phylum_abundance$site

# Plot PCA
var_exp <- summary(pca_res)$cont$importance[2, 1:2] * 100

ggplot(pca_scores, aes(x = PC1, y = PC2, label = site)) +
  geom_point(size = 3, alpha = 0.8, color = "steelblue") +
  geom_text(vjust = -0.6, size = 2) +
  theme_minimal() +
  labs(
    title = "PCA of sites by phylum composition (Hellinger)",
    x = paste0("PC1 (", round(var_exp[1], 1), "%)"),
    y = paste0("PC2 (", round(var_exp[2], 1), "%)")
  )

```

**Notes from Copilot:** PCA is good for linear structure; NMDS handles non-linear relationships and sparse data well.

## Environmental associations (PERMANOVA, envfit, RDA/CCA)

Next I wanted to see if we could use this data set to make certain associations between different soil variables. In order to do this there a different analyses in R that Co-Pilot showed me.

First the ai had me prepare the metadata for these different analyses.

#### Prepare environmental metadata

```{r}
# Select soil chemistry columns (adjust names)
env <- df %>%
  select(site, soilInWaterpH, soilMoisture, soilTemp, soilInCaClpH) %>%
  distinct(site, .keep_all = TRUE)

# Join to match community rows
env <- phylum_abundance %>%
  select(site) %>%
  left_join(env, by = "site")

# Handle missing values conservatively
env_clean <- env %>%
  mutate(across(where(is.numeric), ~ ifelse(is.infinite(.), NA, .))) %>%
  mutate(across(where(is.numeric), ~ ifelse(is.na(.), median(., na.rm = TRUE), .)))

```

A PERMANOVA is a Permutational Multivariate Analysis of Variance which is a statistical test used to compare groups in a complex multivariate data set and is very commonly used for ecological data.

#### PERMANOVA: Do soil variables explain community differences?

```{r}
# Make sure row order of env_clean matches comm_matrix
stopifnot(all(env_clean$Site == phylum_abundance$site))

# Example model (adjust variables)
perm <- adonis2(bray ~ soilInWaterpH + soilMoisture + soilTemp + soilInCaClpH , data = env_clean)
perm

```

From this PERMANOVA we can see that the only variable that significantly explains difference in the community composition is the soilInCaClpH with a p value of 0.019.

#### Envfit: overlay environmental vectors on ordination

Next we used Environmental Fitting which is a part of the vegan package to fit this different variables like pH, temperature and soil type as vectors on an ordination plot aka PCA/NMDS.

```{r}
# Fit onto PCA space
fit <- envfit(pca_res, env_clean %>% select(-site), permutations = 999)

# Extract significant vectors
sig_vecs <- as.data.frame(fit$vectors$arrows) %>%
  mutate(var = rownames(fit$vectors$arrows),
         pval = fit$vectors$pvals) %>%
  filter(pval <= 0.05)
sig_vecs

```

As we can see here, through this analysis, the soilInWaterpH and the soilInCaClpH had a pval of 0.001, meaning that these variables are potentially contributing to differences seen among the sites.

**Notes From Copilot On How To Tidy Data...**

**Code top Reduce sparsity:** Consider filtering phyla with very low totals to reduce noise.

```{r}
keep <- colSums(comm_matrix) > 2
comm_matrix <- comm_matrix[, keep]

```

#### Save Out Put!

```{r}
write.csv(alpha_df, "alpha_diversity.csv", row.names = FALSE)
ggsave("stacked_relative_abundance.png", width = 10, height = 6, dpi = 300)
ggsave("pca_phylum_hellinger.png", width = 8, height = 6, dpi = 300)
ggsave("nmds_bray.png", width = 8, height = 6, dpi = 300)

```

After completing these different analyses, I wanted to make a graph that was informative but more interactive. I remembered one the previous assignments from the R workbook where we made an interactive graph using a map of the United States. Using Co-Pilot, I was able to apply the data from this MAG data set to an interactive map.

### Interactive Map Perfect In R that shows relative abundance values at each site.

First I wanted to see the relative abundance by phylum at each of the sites, a simple proportion of MAGS per phylum.

```{r}
# Install if needed
# install.packages("leaflet")
# install.packages("dplyr")

library(leaflet)
library(dplyr)

# --- Step 1: Read in your dataset ---
df <- read.csv("NEON_soilMAGs_soilChem.csv", header = TRUE, stringsAsFactors = FALSE)

# --- Step 2: Summarize relative abundance per site × phylum ---
# If you don’t have an explicit abundance column, we’ll use counts of MAGs per phylum
site_summary <- df %>%
  group_by(site, decimalLatitude, decimalLongitude, phylum) %>%
  summarise(RelAbund = n() / nrow(df), .groups = "drop")

# --- Step 3: Define color palette for phyla ---
pal <- colorFactor(palette = "Set1", domain = site_summary$phylum)

# --- Step 4: Build interactive map ---
leaflet(site_summary) %>%
  addProviderTiles("CartoDB.Positron") %>%   # nice basemap
  addCircleMarkers(
    lng = ~decimalLongitude,
    lat = ~decimalLatitude,
    radius = ~RelAbund * 1000,   # scale circle size by relative abundance
    color = ~pal(phylum),
    stroke = FALSE,
    fillOpacity = 0.7,
    popup = ~paste0(
      "<b>Site:</b> ", site, "<br>",
      "<b>Phylum:</b> ", phylum, "<br>",
      "<b>Relative Abundance:</b> ", round(RelAbund, 3)
    )
  ) %>%
  addLegend(
    "bottomright",
    pal = pal,
    values = ~phylum,
    title = "Phylum",
    opacity = 1
  )
```

#### **Interactive Map Showing the relative abundance within each site**

In this interactive graph, we can see the relative abundance within each site.

```{r}
# Install if needed
# install.packages("leaflet")
# install.packages("dplyr")

library(leaflet)
library(dplyr)

# --- Step 1: Read in your dataset ---
df <- read.csv("NEON_soilMAGs_soilChem.csv", header = TRUE, stringsAsFactors = FALSE)

# --- Step 2: Summarize relative abundance per site × phylum ---
# If you don’t have an explicit abundance column, we’ll use counts of MAGs per phylum
site_summary <- df %>%
  group_by(site, decimalLatitude, decimalLongitude, phylum) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(site) %>%
  mutate(RelAbund = count / sum(count)) %>%
  ungroup()

# --- Step 3: Define color palette for phyla ---
pal <- colorFactor(palette = "Set1", domain = site_summary$phylum)

# --- Step 4: Build interactive map ---
leaflet(site_summary) %>%
  addProviderTiles("CartoDB.Positron") %>%   # nice basemap
  addCircleMarkers(
    lng = ~decimalLongitude,
    lat = ~decimalLatitude,
    radius = ~RelAbund * 50,   # scale circle size by relative abundance
    color = ~pal(phylum),
    stroke = FALSE,
    fillOpacity = 0.7,
    popup = ~paste0(
      "<b>Site:</b> ", site, "<br>",
      "<b>Phylum:</b> ", phylum, "<br>",
      "<b>Relative Abundance:</b> ", round(RelAbund, 3)
    )
  ) %>%
  addLegend(
    "bottomright",
    pal = pal,
    values = ~phylum,
    title = "Phylum",
    opacity = 1
  )
```

#### **Interactive Map Showing the Dominant Phylum per site**

**(Circle Size Reflects Raw counts)**

```{r}
library(leaflet)
library(dplyr)

# --- Step 1: Read in your dataset ---
df <- read.csv("NEON_soilMAGs_soilChem.csv", header = TRUE, stringsAsFactors = FALSE)

# --- Step 2: Compute dominant phylum per site ---
dominant_phylum <- df %>%
  group_by(site, decimalLatitude, decimalLongitude, phylum) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(site) %>%
  slice_max(order_by = count, n = 1, with_ties = FALSE) %>%   # keep only one phylum per site
  ungroup()

# --- Step 3: Define color palette for phyla ---
pal <- colorFactor(palette = "Set1", domain = dominant_phylum$phylum)

# --- Step 4: Build interactive map ---
leaflet(dominant_phylum) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(
    lng = ~decimalLongitude,
    lat = ~decimalLatitude,
    radius = ~count * 0.5,   # scale circle size by number of MAGs in dominant phylum
    color = ~pal(phylum),
    stroke = FALSE,
    fillOpacity = 0.7,
    popup = ~paste0(
      "<b>Site:</b> ", site, "<br>",
      "<b>Dominant Phylum:</b> ", phylum, "<br>",
      "<b>Count:</b> ", count
    )
  ) %>%
  addLegend(
    "bottomright",
    pal = pal,
    values = ~phylum,
    title = "Dominant Phylum",
    opacity = 1
  )

```

#### **Interactive Map Showing the Dominant Phylum per site**

In this interactive graph, co-pilot suggest that we aggregate the data by dominant phylum per site so at each site one single cirle represents the dominat phylum. These circles also reflect raw counts.

```{r}
library(leaflet)
library(dplyr)

# --- Step 1: Read in your dataset ---
df <- read.csv("NEON_soilMAGs_soilChem.csv", header = TRUE, stringsAsFactors = FALSE)

# --- Step 2: Compute relative abundance per site × phylum ---
site_summary <- df %>%
  group_by(site, decimalLatitude, decimalLongitude, phylum) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(site) %>%
  mutate(RelAbund = count / sum(count)) %>%
  ungroup()

# --- Step 3: Extract dominant phylum per site (highest relative abundance) ---
dominant_phylum <- site_summary %>%
  group_by(site) %>%
  slice_max(order_by = RelAbund, n = 1, with_ties = FALSE) %>%
  ungroup()

# --- Step 4: Define color palette for phyla ---
pal <- colorFactor(palette = "Set1", domain = dominant_phylum$phylum)

# --- Step 5: Build interactive map ---
leaflet(dominant_phylum) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(
    lng = ~decimalLongitude,
    lat = ~decimalLatitude,
    radius = ~RelAbund * 50,   # circle size scaled by relative abundance
    color = ~pal(phylum),
    stroke = FALSE,
    fillOpacity = 0.7,
    popup = ~paste0(
      "<b>Site:</b> ", site, "<br>",
      "<b>Dominant Phylum:</b> ", phylum, "<br>",
      "<b>Relative Abundance:</b> ", round(RelAbund, 3)
    )
  ) %>%
  addLegend(
    "bottomright",
    pal = pal,
    values = ~phylum,
    title = "Dominant Phylum",
    opacity = 1
  )

```

In this next iteration of the interactive graph, I wanted to add back the relative abundance information rather than the raw counts and also make it so you could chose which phylum you are looking at. I prompted co-pilot with my requests and was able to generate the following graph!

```{r}
library(leaflet)
library(dplyr)
library(leaflet.extras)

# --- Step 1: Read in your dataset ---
df <- read.csv("NEON_soilMAGs_soilChem.csv", header = TRUE, stringsAsFactors = FALSE)

# --- Step 2: Compute relative abundance per site × phylum ---
site_summary <- df %>%
  group_by(site, decimalLatitude, decimalLongitude, phylum) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(site) %>%
  mutate(RelAbund = count / sum(count)) %>%
  ungroup()

# --- Step 3: Extract dominant phylum per site ---
dominant_phylum <- site_summary %>%
  group_by(site) %>%
  slice_max(order_by = RelAbund, n = 1, with_ties = FALSE) %>%
  ungroup()

# --- Step 4: Define color palette ---
pal <- colorFactor(palette = "Set1", domain = dominant_phylum$phylum)

# --- Step 5: Build interactive map with legend + filter ---
leaflet(dominant_phylum) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(
    lng = ~decimalLongitude,
    lat = ~decimalLatitude,
    radius = ~RelAbund * 50,
    color = ~pal(phylum),
    stroke = FALSE,
    fillOpacity = 0.7,
    popup = ~paste0(
      "<b>Site:</b> ", site, "<br>",
      "<b>Dominant Phylum:</b> ", phylum, "<br>",
      "<b>Relative Abundance:</b> ", round(RelAbund, 3)
    ),
    group = ~phylum   # group markers by phylum for filtering
  ) %>%
  addLegend(
    "bottomright",
    pal = pal,
    values = ~phylum,
    title = "Dominant Phylum",
    opacity = 1
  ) %>%
  addLayersControl(
    overlayGroups = unique(dominant_phylum$phylum),
    options = layersControlOptions(collapsed = FALSE)
  )

```

In this graph...

`group = ~phylum`: assigns each marker to a group based on its phylum.

-   `addLayersControl()`: adds a control box so you can toggle phyla on/off interactively.

-   **Legend**: still shows the color mapping for phyla.

## Happy Coding and Good Luck!
